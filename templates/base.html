{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Nota Shop</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}"/>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;600;800&display=swap" rel="stylesheet"/>
</head>
<body>

<header>
    <div class="header-left">
        <a href="{% url 'home' %}" class="home-button" aria-label="Home">
            <svg xmlns="http://www.w3.org/2000/svg" fill="#2c2c2c" viewBox="0 0 24 24" width="28" height="28"
                 aria-hidden="true">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
        </a>

        {% if not user.is_authenticated %}
            <nav class="auth-nav">
                <a href="{% url 'login' %}" class="btn">Login</a>
                <a href="{% url 'signup' %}" class="btn">Sign Up</a>
            </nav>
        {% else %}
            <nav class="auth-nav">
                <span class="nav-welcome">Hi, {{ user.username }}</span>
                <form method="post" action="{% url 'logout' %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn">Logout</button>
                </form>
            </nav>
        {% endif %}
    </div>

    <div class="header-center logo-container">
        <a href="{% url 'home' %}">
            <img src="{% static 'images/logo.png' %}" alt="Nota Shop Logo" class="logo"/>
        </a>
    </div>

    <div class="header-right">
        <a href="{% url 'cart_detail' %}" class="cart-link">
            ðŸ›’ Cart (<span id="cart-count">{{ cart|length }}</span>)
        </a>

        <div class="search-wrapper">
            <form action="{% url 'sticker_search' %}" method="get" class="search-form">
                <input type="text" name="q" placeholder="Search stickers..." required>
                <button type="submit" class="search-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#2c2c2c" viewBox="0 0 24 24" width="20" height="20">
                        <path d="M21.71 20.29l-3.388-3.387a8 8 0 10-1.414 1.414l3.387 3.388a1 1 0 001.415-1.415zM10 16a6 6 0 116-6 6 6 0 01-6 6z"/>
                    </svg>
                </button>
            </form>
        </div>

        <button id="menu-toggle" aria-label="Toggle menu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="#2c2c2c" viewBox="0 0 24 24" width="28" height="28"
                 aria-hidden="true">
                <path d="M3 6h18M3 12h18M3 18h18" stroke="#2c2c2c" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>

        <nav id="dropdown-menu" class="dropdown-menu" aria-hidden="true">
            <a href="{% url 'sticker_list' %}">All Stickers</a>

            {% for category in categories %}
                <a href="{% url 'category_detail' category.slug %}">{{ category.name }}</a>
            {% endfor %}

            <a href="{% url 'list' %}">Articles</a>

            {% if user.is_superuser %}
                <a href="{% url 'create' %}">Create Article</a>
                <a href="{% url 'sticker_create' %}">Create Sticker</a>
            {% endif %}
        </nav>
    </div>
</header>

<main>
    {% block content %}
    {% endblock %}
</main>

<footer>
    &copy; 2025 Nota Shop â€” All Rights Reserved
</footer>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        function updateCartDisplay(stickerId, quantity, cartCount) {
            const card = document.querySelector(`.product-card[data-sticker-id='${stickerId}']`);
            if (card) {
                const qtySpan = card.querySelector(".quantity");
                if (qtySpan) qtySpan.textContent = quantity;
            }
            const cartCountElem = document.querySelector("#cart-count");
            if (cartCountElem) cartCountElem.textContent = cartCount;
        }

        function showCartPopup(message) {
            const popup = document.createElement('div');
            popup.className = 'cart-popup';
            popup.textContent = message;
            document.body.appendChild(popup);
            setTimeout(() => popup.classList.add('show'), 50);
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => popup.remove(), 400);
            }, 3000);
        }

        // Handle AJAX forms
        document.querySelectorAll(".add-to-cart-form, .cart-decrement, .cart-remove").forEach(form => {
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                const url = this.action;
                const formData = new FormData(this);

                fetch(url, {
                    method: "POST",
                    body: formData,
                    headers: {"X-Requested-With": "XMLHttpRequest"}
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            const qty = data.quantity || 0;
                            const cartCount = data.cart_count || 0;
                            updateCartDisplay(data.sticker_id, qty, cartCount);

                            if (this.classList.contains('add-to-cart-form')) {
                                showCartPopup(`Added ${qty} item(s) to cart! Total items: ${cartCount}`);
                            }
                        }
                    })
                    .catch(err => console.error('Cart AJAX error:', err));
            });
        });

    });
</script>

</body>
</html>
